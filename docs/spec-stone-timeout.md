# 仕様検討結果: 終了ログ未記録時の石の描画

> 検討日: 2026-02-21
> 参加者: 論理的（クリティカルシンキング）、創造的（アイデア発想）、原理主義（CORE.md哲学遵守）

## 背景と課題

nagiはiOSショートカット経由で「アプリを開いた」イベントのみをログとして記録する。
「アプリを閉じた」ログが記録されない場合、タイムライン上の石（拘束時間）が最後のログから際限なく伸びてしまう。

### 現状の挙動（`VisualTimeline.tsx`）

1. ログは `{ts, app}` 形式（開始イベントのみ）
2. `targetApps` に含まれるアプリのログ → 石（拘束）開始
3. それ以外のログ（空文字=ホーム画面含む）→ 波（解放）に戻る
4. 最後のログの状態が `limitMin`（今日=現在時刻、過去=24:00）まで延長される

### 主な問題ケース

| ケース | 内容 | 発生頻度 |
|--------|------|----------|
| A. 寝落ち | 対象アプリを開いたまま就寝 → 翌朝まで石が8時間以上延長 | 高 |
| B. オートメーション発火失敗 | バッテリー切れ、OS制限等 → 終了ログなし | 中 |
| C. ホーム画面を経由しない遷移 | 通知タップ等で直接別アプリへ → トリガー条件外 | 中 |
| D. 本当に長時間使用 | 動画視聴等の正常データ（誤って切ってはいけない） | 低〜中 |
| E. 日付跨ぎ | 前日深夜の対象アプリログが翌日0:00から石として継承される | 中 |

## CORE.mdに照らした分析

### 2種類のエラー

議論の中核となったフレームワーク：

| エラータイプ | 内容 | 例 | ユーザーへの影響 | CORE.md違反 |
|-------------|------|-----|-----------------|-------------|
| **Type A: 過剰表示** | 実際より長い石 | 10分の使用 → 6時間の石 | 不当な罪悪感（重大） | No Guilt違反 |
| **Type B: 過小表示** | 実際より短い石 | 2時間の使用 → 1時間の石 | 傷つけない（軽微） | 鏡の歪み（軽微） |

**結論**: Type A（過剰率 最大3600%）はType B（過少率 最大11%）と比べ桁違いに深刻。
CORE.md最上位原則「自責からの解放」に基づき、**Type Aエラーの防止を優先**する。

### 検討した対処法（6案）

| 案 | 内容 | Zero Friction | No Guilt | Unobtrusive | 採否 |
|----|------|:---:|:---:|:---:|:---:|
| A. 固定タイムアウト | N時間で強制終了 | △ | ○ | ○ | 不採用 |
| B. 深夜切断 | 深夜帯のみ短いタイムアウト | ○ | ○ | ○ | → Fに統合 |
| C. 統計的異常検知 | 過去データからパーセンタイル計算 | × | ○ | △ | 不採用（過剰設計） |
| D. UI上で不確実性を可視化 | 注釈・点線・ツールチップ等 | × | △ | × | 不採用（哲学違反） |
| E. 現状維持 | 何もしない | ◎ | × | ◎ | 不採用（No Guilt違反） |
| **F. ハイブリッド** | **タイムアウト + 深夜切断** | **○** | **○** | **○** | **採用** |

## 決定事項

### 1. タイムアウトロジック

```
通常時間帯 (6:00-23:59): 最後のログから 3.5時間 経過で石を終了 → 波に切り替え
深夜時間帯 (0:00-5:59): 最後のログから 1時間 経過で石を終了 → 波に切り替え
日付跨ぎ: 前日最終ログが 23:00以降 の場合、翌日は 0:00から波で開始
```

**閾値の根拠:**

- **3.5時間（通常）**: SNSアプリの99パーセンタイルセッション長（2-3時間）をカバー。寝落ち8時間ケースを56%削減
- **1時間（深夜）**: 深夜帯は寝落ちケースの頻度が圧倒的に高い（推定70%以上）。総苦痛量の最小化を優先
- **23:00（日付跨ぎ）**: 日本の就寝時刻の多数派（23:00-24:30）をカバーしつつ保守的に設定

### 2. 視覚表現: 霞・霧のオーバーレイ（オプション）

タイムアウトに近づく石の上に、白い霞のグラデーションを重ねる。

```
最後のログ直後 → 霧なし（確実）
時間経過に応じて → 霧が徐々に濃くなる
タイムアウト直前 → 最大の霧（不確実）
```

**CORE.md適合性の検証:**

- **Zero Friction**: 説明不要、自動適用、ユーザーに操作を求めない → **違反しない**
- **No Guilt**: 霞は柔らかく優しい表現、罪悪感を与えない → **違反しない**
- **Unobtrusive**: 控えめな実装（opacity 0.1-0.3）なら主張しない → **条件付きで許容**
- **メタファー**: 凪いだ海の朝霧、日本的な曖昧さの美学 → **世界観と調和**

**原理主義の判断（再検討後）**: 当初は「視覚的区別は絶対禁止」としていたが、「説明テキストを伴う可視化」と「メタファーとしての視覚表現」は異なると認識を修正。霞は条件付きで許容可能。

**必須条件:**
1. 説明テキストを一切追加しない（凡例にも「霧=推測」と書かない）
2. 控えめな視覚効果（opacity 0.1-0.3、自然なグラデーション）
3. 気づかない人は気づかないレベルの繊細さ
4. 石・波のメタファーとの調和を保つ

### 3. 実装時の厳守事項

1. タイムアウトの存在を**ユーザーに一切知らせない**
2. ログに「タイムアウトで終了」などの記録を**残さない**
3. タイムアウト閾値の「ユーザー設定」を**追加しない**
4. 将来的にも説明テキストやモーダルを**追加しない**

## 実装ガイド

### Phase 1: タイムアウトロジック

`VisualTimeline.tsx` L83-97（最後のログからlimitMinまでの延長処理）を修正：

```typescript
// タイムアウトチェック
const lastLogHour = new Date(lastTs).getHours();
const isDuringNighttime = lastLogHour >= 0 && lastLogHour < 6;
const timeoutMinutes = isDuringNighttime ? 60 : 210; // 1時間 or 3.5時間

const maxEndMin = startMin + timeoutMinutes;
const effectiveLimitMin = Math.min(limitMin, maxEndMin);
// effectiveLimitMin まで石を延長（その後は波）
```

L51（前日最終ログの継承）を修正：

```typescript
const prevLogHour = prevDayLastLog ? new Date(prevDayLastLog.ts).getHours() : null;
const isPrevLogLateNight = prevLogHour !== null && prevLogHour >= 23;
let isStoneActive = isPrevLogLateNight
  ? false
  : (prevDayLastLog ? targetApps.includes(prevDayLastLog.app) : false);
```

### Phase 2: 霞・霧オーバーレイ（オプション）

石のレンダリング部分に霞レイヤーを追加：

```typescript
// uncertaintyFactor: 0（確実）〜 1（タイムアウト直前）
const uncertaintyFactor = Math.min(1, elapsedMinutes / timeoutMinutes);
```

```tsx
{seg.uncertaintyFactor > 0 && (
  <div
    className="absolute inset-0 pointer-events-none"
    style={{
      background: `linear-gradient(to right, transparent, rgba(255,255,255,${seg.uncertaintyFactor * 0.3}))`,
    }}
  />
)}
```

## 哲学的根拠

> CORE.md 1章: 怒りや罰ではなく、「許し」と「気づき」を出発点とする。

完璧な解は存在しない。終了イベントが記録されない以上、どの手法も推測を含む。

しかし、「すべてのユーザーに正確なデータ」が不可能である以上、「最も傷つけない選択」を取るべきである。Type Aエラー（不当な罪悪感）を防ぐために、Type Bエラー（過小表示）を受け入れる。これは、CORE.mdの「自責からの解放」という最上位原則に従った判断である。

霞に包まれた石は、もはや「拘束」ではなく「記憶の彼方」にある淡い影。ユーザーを責めず、システムの限界を隠さず、しかし優しく包む。
